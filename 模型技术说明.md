# 结霜仿真模型技术说明

## 1. 模型概述

本仿真模型用于预测换热器在不同工况下的结霜过程，采用基于LSTM的时序神经网络架构，支持多步自回归预测。

## 2. 时间处理机制

### 2.1 时间表示方式
- **相对进程时间**：采用归一化的相对时间，而非绝对时间戳
- **归一化范围**：t ∈ [0, 1]
- **实现方式**：`t_normalized = np.linspace(0, 1, n_steps)`

### 2.2 时间在模型中的作用
- 时间作为**工况特征**之一输入模型
- 反映结霜过程的进展程度
- 帮助模型学习时间相关的物理演化规律

```python
# 归一化时间生成
n_steps = len(data)
t_normalized = np.linspace(0, 1, n_steps)
```

## 3. 模型输入输出

### 3.1 输入特征（16维）

#### 状态特征（12维）- 当前时刻状态
1. 空气侧压降
2. 平均风速
3. 单位时间结霜量
4. 空气侧换热量
5. 水侧换热量
6. 进口温度
7. 进口湿度
8. 进口热电偶温度
9. 换热器进口温度
10. 出口平均温度
11. 出口平均湿度
12. 换热器出口温度

#### 工况特征（4维）- 固定条件
1. 翅片间距（fin_spacing）：5mm, 7.5mm, 10mm, 15mm, 20mm, 30mm
2. 初始风速（initial_wind_speed）：实验初始值
3. 流量（flow_rate）：0.5 或 1.0
4. 归一化时间（normalized_time）：当前时间进度 [0, 1]

### 3.2 输出特征（12维）
- **预测目标**：下一时刻的完整状态（绝对值）
- **预测方式**：直接预测状态值，而非变化量
- **输出维度**：与状态特征相同的12维

```python
# 预测流程示意
current_state = [压降_t, 风速_t, 结霜量_t, ...]  # 12维
condition = [翅片间距, 初始风速, 流量, t/T]      # 4维
next_state = model(current_state, condition)      # 预测12维
```

## 4. 预测机制

### 4.1 单步预测
- 每次预测**下一个时间步**的状态
- 不使用滑动窗口，而是单步状态转移
- 训练时：`state[t] + condition → state[t+1]`

### 4.2 多步自回归预测
测试阶段采用自回归方式进行多步预测：

```python
# 初始化
predictions[0] = data[0]  # 第一步使用真实值

# 自回归预测
for t in range(1, n_steps):
    current_state = predictions[t-1]        # 使用上一步预测值
    condition = [翅片间距, 初始风速, 流量, t/T]
    predictions[t] = model(current_state, condition)
```

### 4.3 测试集预测说明
- **真实值**：仅第一个时间步（t=0）
- **预测值**：从第二个时间步开始（t=1到t=n-1）全部为预测
- **误差累积**：后续预测依赖前序预测，存在误差累积效应

## 5. 模型架构

### 5.1 EnhancedLSTM结构

```
输入层
├── 状态编码器（State Encoder）
│   └── Linear(12 → 192) → LayerNorm → ReLU → Dropout(0.2)
│
└── 工况编码器（Condition Encoder）
    └── Linear(4 → 96) → LayerNorm → ReLU → Dropout(0.2)

融合层
└── Concatenate(192 + 96 = 288维)

LSTM核心
└── 3层LSTM(input=288, hidden=192, dropout=0.2)

解码器
└── Linear(192 → 192) → LayerNorm → ReLU → Dropout(0.2)
    └── Linear(192 → 12)

输出层
└── 下一时刻状态（12维）
```

### 5.2 关键超参数
- **隐藏层维度**：192
- **LSTM层数**：3
- **Dropout率**：0.2
- **归一化**：LayerNorm（稳定训练）

## 6. 损失函数设计

### 6.1 V18损失函数
```
L_total = MSE + λ_physics * (L_energy + L_monotonic + L_pressure + L_temperature)
```

#### 组成部分：
1. **MSE损失**：数据对齐
   - `MSE(predicted_state, true_state)`

2. **能量守恒约束**：
   - `L_energy = mean((Q_air - Q_water)²) / (mean(Q_air²) + ε)`

3. **单调性约束**：
   - `L_monotonic = mean(ReLU(frost_t - frost_{t+1})²)`
   - 结霜量应单调递增

4. **压力增长约束**：
   - `L_pressure = 0.5 × mean(ReLU(pressure_t - pressure_{t+1})²)`
   - 压降应单调递增

5. **温度合理性约束**：
   - `L_temp = Σ 0.1 × mean(ReLU(|ΔT| - 5)²)`
   - 温度变化不应超过5°C

**权重设置**：
- `mse_weight = 1.0`
- `physics_weight = 0.1`

### 6.2 V40损失函数
```
L_total = MSE
```
- 仅数据驱动，无物理约束
- 作为消融实验对照组

### 6.3 V41损失函数
```
L_total = MSE + λ_physics * (L_energy + L_mass + L_monotonic + L_pressure + L_temperature)
```

在V18基础上增加：
- **质量守恒约束**：
  - `L_mass = mean((frost_rate_{t+1} - frost_rate_t)²)`
  - 结霜速率平滑性约束

## 7. 数据预处理

### 7.1 标准化策略
- **状态变量**：StandardScaler标准化（零均值，单位方差）
- **工况变量**：StandardScaler标准化
- **作用**：保证不同量纲特征的数值平衡

### 7.2 标准化流程
```python
# 训练集拟合标准化器
state_scaler.fit(train_data)
condition_scaler.fit(train_conditions)

# 训练和测试均使用训练集标准化器
train_normalized = state_scaler.transform(train_data)
test_normalized = state_scaler.transform(test_data)
```

### 7.3 反标准化
- **物理约束计算**：需要反标准化到原始量纲
- **最终输出**：反标准化后的物理值

## 8. 训练策略

### 8.1 Leave-One-Out交叉验证
- **数据集划分**：11个工况条件
- **验证方式**：每次选1个工况作为测试集，其余10个作为训练集
- **总实验次数**：11次（每个工况都作为测试集一次）

### 8.2 训练配置
```python
优化器: AdamW
学习率: 0.001
权重衰减: 1e-4
学习率调度: CosineAnnealingLR(T_max=100, eta_min=1e-6)
批次大小: 64
最大轮数: 100
早停策略: 耐心值=20（20轮无改善则停止）
梯度裁剪: max_norm=1.0
```

### 8.3 早停机制
- 监控训练损失
- 连续20个epoch无改善则提前停止
- 防止过拟合，节省计算资源

## 9. 评估指标

### 9.1 R²决定系数
```
R² = 1 - SS_res / SS_tot
SS_res = Σ(y_true - y_pred)²
SS_tot = Σ(y_true - mean(y_true))²
```

### 9.2 评估范围
- **R² = 1**：完美预测
- **R² = 0**：预测等同于均值
- **R² < 0**：预测差于均值（过拟合或模型失效）

### 9.3 分变量评估
对12个状态变量分别计算R²：
- 可识别模型在不同物理量上的表现差异
- 关键变量：空气侧压降、单位时间结霜量、空气/水侧换热量

## 10. 物理约束的反标准化处理

### 10.1 为何需要反标准化
- 物理约束在**原始量纲**下才有意义
- 标准化后的数值无法直接应用物理定律

### 10.2 实现方式
```python
# 在损失函数中反标准化
pred_denorm = state_scaler.inverse_transform(pred)
current_denorm = state_scaler.inverse_transform(current_state)

# 在原始量纲下计算物理约束
Q_air = pred_denorm[:, 3]  # 空气侧换热量（原始单位）
Q_water = pred_denorm[:, 4]  # 水侧换热量（原始单位）
energy_loss = (Q_air - Q_water)²
```

## 11. 工况条件说明

### 11.1 实验工况组合
| 翅片间距 | 流量0.5 | 流量1.0 |
|---------|--------|--------|
| 5mm     | -      | ✓      |
| 7.5mm   | ✓      | ✓      |
| 10mm    | ✓      | ✓      |
| 15mm    | ✓      | ✓      |
| 20mm    | ✓      | ✓      |
| 30mm    | ✓      | ✓      |

共11个工况条件。

### 11.2 工况特征的作用
- **泛化能力**：模型学习跨工况的物理规律
- **条件预测**：可预测未见过的工况组合
- **物理一致性**：工况特征引导预测符合物理常识

## 12. 关键技术点总结

| 技术点 | 设计方案 | 原因 |
|--------|---------|------|
| 时间表示 | 归一化相对时间 | 适应不同实验长度，消除绝对时间影响 |
| 预测目标 | 绝对状态值 | 直接预测，避免累积误差放大 |
| 预测方式 | 单步自回归 | 符合物理演化过程，支持任意步长预测 |
| 窗口大小 | 不使用窗口（单步） | 简化模型，利用LSTM内部记忆机制 |
| 测试预测 | 仅初值真实，其余全预测 | 真实仿真场景，评估长期预测能力 |
| 物理约束 | 损失函数软约束 | 引导学习，不破坏数据拟合 |
| 标准化 | 全局StandardScaler | 数值稳定，加速收敛 |
| 交叉验证 | Leave-One-Out | 充分利用数据，评估泛化能力 |

## 13. 模型版本对比

| 版本 | 损失函数 | 目的 |
|------|---------|------|
| V18 | MSE + 能量 + 单调 + 压力 + 温度 | 原始物理约束版本 |
| V40 | 仅MSE | 纯数据驱动，消融实验对照 |
| V41 | MSE + 能量 + 质量 + 单调 + 压力 + 温度 | 完整物理约束版本 |

消融实验目的：
- V40 vs V18：评估物理约束的作用
- V41 vs V18：评估质量守恒约束的增益
- 三者对比：找到最优约束组合
